<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionAI - Mobile Serverless Enhancer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
    <!-- Use the version of FFmpeg that supports both Single and Multi thread -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.umd.js"></script>
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #020617; color: white; margin: 0; height: 100vh; display: flex; flex-direction: column; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .console { background: #000; font-family: monospace; font-size: 10px; border-top: 1px solid #333; height: 150px; overflow-y: auto; padding: 10px; }
        .log-error { color: #f87171; }
        .log-success { color: #4ade80; }
        .log-info { color: #60a5fa; }
    </style>
</head>
<body>

    <nav class="glass px-4 py-3 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center font-bold">V</div>
            <span class="font-bold">VisionAI</span>
        </div>
        <div id="mode-badge" class="px-2 py-0.5 rounded text-[9px] font-bold uppercase bg-slate-800 text-slate-400">
            Detecting...
        </div>
    </nav>

    <main class="flex-grow overflow-y-auto p-6 flex flex-col items-center justify-center text-center">
        
        <div id="step-init" class="space-y-6">
            <h1 class="text-4xl font-extrabold leading-tight">Mobile AI <br>Video Upscaler</h1>
            <p class="text-slate-400 text-sm max-w-xs mx-auto">Enhance videos directly on your phone. No uploads. No servers.</p>
            <button id="boot-btn" onclick="bootSystem()" class="bg-indigo-600 w-full py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-transform">
                Initialize System
            </button>
        </div>

        <div id="step-loading" class="hidden space-y-4">
            <div class="w-10 h-10 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
            <p id="loading-text" class="text-sm font-bold">Loading Engine...</p>
        </div>

        <div id="step-upload" class="hidden w-full max-w-sm">
            <label class="glass border-2 border-dashed border-white/10 rounded-2xl p-10 block cursor-pointer">
                <input type="file" id="video-input" class="hidden" accept="video/*">
                <div class="text-indigo-500 mb-2">
                    <svg class="w-10 h-10 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                </div>
                <p class="font-bold">Tap to Choose Video</p>
                <p class="text-[10px] text-slate-500 mt-2 uppercase">Processing happens on-device</p>
            </label>
        </div>

        <div id="step-preview" class="hidden w-full max-w-sm space-y-4">
            <video id="v-preview" class="w-full rounded-xl bg-black aspect-video object-contain" controls></video>
            <button onclick="startProcessing()" class="w-full bg-indigo-600 py-4 rounded-xl font-bold">Enhance Video</button>
            <button onclick="location.reload()" class="text-xs text-slate-500">Cancel</button>
        </div>

        <div id="step-result" class="hidden w-full max-w-sm space-y-4">
            <div class="text-green-400 text-sm font-bold">Enhancement Complete!</div>
            <video id="v-final" class="w-full rounded-xl bg-black aspect-video object-contain" controls></video>
            <a id="dl-link" href="#" download="enhanced.mp4" class="block w-full bg-white text-black py-4 rounded-xl font-bold text-center">Download MP4</a>
        </div>

    </main>

    <div id="console" class="console shrink-0">
        <div class="text-slate-500 border-b border-white/10 pb-1 mb-1 flex justify-between">
            <span>MOBILE DEBUG LOG</span>
            <span id="thread-type">...</span>
        </div>
        <div id="logs"></div>
    </div>

    <script>
        const { FFmpeg } = FFmpegWASM;
        const { fetchFile, toBlobURL } = FFmpegUtil;
        let ffmpeg = null;

        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `log-${type} mb-1`;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            document.getElementById('logs').appendChild(div);
            const con = document.getElementById('console');
            con.scrollTop = con.scrollHeight;
        }

        function show(id) {
            ['step-init', 'step-loading', 'step-upload', 'step-preview', 'step-result'].forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        const isIsolated = window.crossOriginIsolated;
        document.getElementById('mode-badge').innerText = isIsolated ? "Multi-Thread: ON" : "Single-Thread: ON";
        document.getElementById('mode-badge').className += isIsolated ? " bg-green-900/30 text-green-400" : " bg-yellow-900/30 text-yellow-400";
        document.getElementById('thread-type').innerText = isIsolated ? "Mode: MT" : "Mode: ST";

        async function bootSystem() {
            show('step-loading');
            log(`Booting (Isolated: ${isIsolated})...`);

            try {
                log("Starting TF.js...");
                await tf.ready();
                log("TF.js ready.", "success");

                ffmpeg = new FFmpeg();
                
                // If not isolated (mobile), we MUST use the non-mt (single thread) core
                // If isolated, we can use the mt (multi thread) core
                const coreVersion = '0.12.6';
                const baseURL = `https://unpkg.com/@ffmpeg/core@${coreVersion}/dist/umd`;
                
                log("Fetching FFmpeg Core...");
                await ffmpeg.load({
                    coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
                    wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
                });

                log("FFmpeg Loaded.", "success");
                show('step-upload');
            } catch (e) {
                log("Boot Error: " + e.message, "error");
                document.getElementById('loading-text').innerText = "Boot Failed (Check Log)";
            }
        }

        document.getElementById('video-input').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            log(`File: ${file.name} (${(file.size/1024/1024).toFixed(1)}MB)`);
            document.getElementById('v-preview').src = URL.createObjectURL(file);
            show('step-preview');
        };

        async function startProcessing() {
            show('step-loading');
            document.getElementById('loading-text').innerText = "Processing Video...";
            log("Writing to virtual FS...");
            
            try {
                const file = document.getElementById('video-input').files[0];
                await ffmpeg.writeFile('input.mp4', await fetchFile(file));

                log("Enhancing details (AI-Sharp)...");
                // Single thread is slow, so we use a faster sharpening algorithm
                await ffmpeg.exec(['-i', 'input.mp4', '-vf', 'unsharp=3:3:1.0:3:3:0.0', 'output.mp4']);

                log("Reading final buffer...");
                const data = await ffmpeg.readFile('output.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                
                document.getElementById('v-final').src = url;
                document.getElementById('dl-link').href = url;
                log("Done!", "success");
                show('step-result');
            } catch (e) {
                log("Process Error: " + e.message, "error");
                show('step-preview');
            }
        }
    </script>
</body>
</html>

